# AGENTS.md
> このファイルは `AGENTS.md` の日本語翻訳です。**正本（canonical）は `AGENTS.md`** であり、内容に差分がある場合は `AGENTS.md` を優先してください。  

このリポジトリでは「小さな仕様ドキュメント（docs/）を起点に、AI主導で少しずつ実装していく」開発手法を採用する。
本ファイルは、AI（エージェント）への行動規約・出力フォーマット・品質ゲートを定義する。

---

## 0. 目的
- docs/ 配下の小仕様を単位として、確実に「計画 → 実装 → 受け入れ → コミット」まで進める
- 仕様の曖昧さを早期に炙り出し、ユーザーの意思決定ポイントを最小の質問で提示する
- 既存挙動の回帰を避けつつ、小さな差分で実装する

---

## 1. 前提（このリポジトリの開発スタイル）
- 仕様は `docs/feat-*.md` / `docs/fix-*.md` に書く（小さく、独立して）
- AIは「実装開始の明示指示」があるまでコード変更を行わない（計画フェーズでは読んで整理するだけ）
- 実装後の受け入れテストはユーザーが行い、OKならコミットする（AIはコミットを勝手にしない）

---

## 2. AIの基本ロール
AIは以下を順守する。

### 2.1 計画フェーズ（ユーザーが計画記入を依頼したとき）
- 対象ドキュメント（例: docs/feat-xxxx.md）と既存コードを読む
- 仕様の不明点・矛盾・不足を「指摘リスト」として提示する
- 仕様が十分に明確なら、ドキュメント末尾に **チェックリスト形式の「# 実装計画」** を追記または更新する
- 計画は「最小差分」「回帰確認」「エラー仕様」「レスポンス形式」「互換性方針」を必ず含める

### 2.2 実装フェーズ（ユーザーが「実装開始」を指示したとき）
- 実装計画チェックリストに沿って、順番に実装する
- 各チェック項目が完了したらチェックを付け、必要なら補足を書く
- 既存挙動の回帰確認を必ず行う（少なくとも手動/簡易テスト手順の提示）
- 仕様にない変更（仕様外のリファクタや挙動変更）はしない。必要なら「別docs化」を提案する

### 2.3 完了フェーズ（実装完了後）
- ユーザー向けに受け入れ手順を提示する（curl例 / 実行コマンド / 期待出力）
- 既知の制約や未対応があれば明確に記載する
- ユーザーがOKと言ったら、コミットメッセージ案を提示する（コミット自体はユーザーが実施）

---

## 3. docs仕様ドキュメントの書式（推奨）
docs/feat-xxxx.md / docs/fix-xxxx.md は、以下のセクションを推奨する。

- # 概要（1〜3行で何をするか）
- # 変更の背景（任意）
- # 仕様（入力、出力、例、エラー、互換性方針）
- # 実装方針（任意：既存ロジック流用、互換性を気にする/しない、など）
- # 実装計画（AIが埋める／更新する）

---

## 4. 「# 実装計画」の必須フォーマット（厳守）
AIは必ずこの形式で書く。粒度は「チェックが付く単位（小さめ）」にする。

# 実装計画
* [ ] 〇〇を実装
   - 詳細a
   - 詳細b
* [ ] ルート/ハンドラ/ユースケースを更新
   - パラメータ: xxx
   - レスポンス: md/json の取り扱い
   - エラー: 空データ時は 404 + "not found" 等
* [ ] 回帰確認
   - 既存の xxx が変わらないこと
   - mode指定の動作確認（例: mode=json / mode未指定）
* [ ] 受け入れ手順を追記
   - curl例
   - 期待出力例

※ 仕様により、互換性を「気にしない（未リリース）」場合はその旨を計画に明記する。

---

## 5. 仕様の曖昧さの扱い（AIの質問ポリシー）
AIは計画作成時に曖昧な点を見つけたら、次を守る。

- 「実装できないレベルの曖昧さ」だけ質問する（質問は最小限）
- 質問は選択肢つきで提示する（例: A/B/C）
- 質問が解消できるまで、実装は開始しない
- ただし、仕様ドキュメント内に「互換性は気にしない」「未指定はmdでOK」など明記がある場合は、それに従う

---

## 6. 出力・エラー・互換性（品質ゲート）
計画にも実装にも、最低限以下を含める。

### 6.1 HTTP / API の場合
- パラメータの必須/任意、型、デフォルト
- mode（例: md/json）と Content-Type
- エラー仕様（例: 空データ時 404 + "not found" を text/plain など）
- 並び順・丸め規則（例: 秒→分は切り上げ、降順ソート、同値は任意/名前昇順）

### 6.2 互換性方針
- 互換性を守るのか、破壊的変更を許すのかを明記する
- 破壊的変更を許す場合、削除対象（例: /drill-down を削除）を計画に入れる

### 6.3 回帰確認
- 「既存の通常系」が変わっていないことを確認するチェック項目を必ず入れる
  - 例: project未指定時の /stats の md/json 出力が変わらない、など

---

## 7. 実装時のルール（やってよい / だめ）
### やってよい
- 仕様ドキュメントに書かれた挙動を満たす最小変更
- 既存ロジックの流用（例: 既存の集計関数や分類関数を使う）
- 受け入れ用のコマンド例（curl等）を追加する

### だめ
- 仕様に書かれていない挙動変更（暗黙の仕様追加）
- 大規模リファクタ（必要なら別の docs/ を作って提案）
- ユーザーの明示指示なしの実装開始
- ユーザーの了承なしのコミット・リリース関連操作

---

## 8. 実装完了時の報告テンプレ
実装完了したら、AIは次を必ず出す。

- 変更点サマリ（箇条書き）
- 受け入れテスト手順（コマンド、期待結果、確認観点）
- 影響範囲と回帰確認の結果（やったこと/未実施なら理由）
- コミットメッセージ案（1つ以上）

---

## 9. 補足（このリポジトリでよく出る例）
- mode=md/json の切替、未指定のデフォルト（例: md）
- 空データ時の 404 + "not found"
- 集計結果の並び順（時間降順、同値の扱い）
- 秒→分の丸め（切り上げ）
- 互換性を気にしない場合のルート削除（未リリース前提）
